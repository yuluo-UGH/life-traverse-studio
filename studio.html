<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>老年工作室 · LifeTraverse</title>
  <style>
    :root {
      color-scheme: dark;
      --bg: #020617;
      --card: #020617;
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.12);
      --text-main: #f9fafb;
      --text-sub: #9ca3af;
      --border-soft: #1f2937;
      --danger: #f97373;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "PingFang SC", "Microsoft YaHei", sans-serif;
      background: radial-gradient(circle at top, #020617 0, #000 80%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      justify-content: center;
    }
    .app {
      width: 100%;
      max-width: 960px;
      padding: 16px 12px 28px;
    }
    @media (min-width: 768px) {
      .app { padding: 20px 16px 32px; }
    }
    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .top-title {
      font-size: 18px;
      font-weight: 650;
    }
    .top-subtitle {
      font-size: 12px;
      color: var(--text-sub);
      margin-top: 2px;
    }
    .avatar {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: default;
    }
    .avatar-circle {
      width: 30px;
      height: 30px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #22c55e, #0b1120);
      border: 1px solid rgba(248, 250, 252, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: 600;
    }
    .avatar-text-main {
      font-size: 13px;
      font-weight: 600;
    }
    .avatar-text-sub {
      font-size: 11px;
      color: var(--text-sub);
    }

    .studio-tabs {
      display: flex;
      gap: 6px;
      margin: 10px 0 12px;
      overflow-x: auto;
      padding-bottom: 2px;
    }
    .studio-tab {
      flex: 1;
      min-width: 0;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: rgba(15, 23, 42, 0.9);
      padding: 6px 10px;
      font-size: 13px;
      color: var(--text-sub);
      display: flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
      cursor: pointer;
      transition: background 0.15s ease-out, border-color 0.15s ease-out, color 0.15s ease-out, transform 0.08s ease-out;
    }
    .studio-tab span {
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .studio-tab.active {
      color: var(--text-main);
      border-color: var(--accent);
      background: radial-gradient(circle at top left, var(--accent-soft), rgba(15, 23, 42, 0.96));
      transform: translateY(-1px);
    }

    .layout {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    @media (min-width: 768px) {
      .layout {
        flex-direction: row;
        align-items: flex-start;
      }
    }
    .panel {
      background: rgba(15, 23, 42, 0.96);
      border-radius: 14px;
      border: 1px solid var(--border-soft);
      padding: 10px 11px 11px;
    }
    @media (min-width: 768px) {
      .panel { padding: 12px 13px 13px; }
    }
    .panel-left {
      flex: 0 0 280px;
    }
    .panel-right {
      flex: 1;
      min-width: 0;
    }

    .studio-name {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .studio-fullname {
      font-size: 12px;
      color: var(--text-sub);
      margin-bottom: 8px;
    }
    .studio-desc {
      font-size: 13px;
      color: var(--text-sub);
      line-height: 1.7;
      margin-bottom: 10px;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 4px;
    }
    .btn-main, .btn-ghost {
      border-radius: 999px;
      border: none;
      font-size: 13px;
      padding: 7px 14px;
      cursor: pointer;
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      transition: background 0.12s ease-out, color 0.12s ease-out, border-color 0.12s ease-out, transform 0.08s ease-out;
    }
    .btn-main {
      background: linear-gradient(135deg, var(--accent), #4ade80);
      color: #022c22;
      font-weight: 560;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
    }
    .btn-main:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 22px rgba(0, 0, 0, 0.45);
    }
    .btn-main:active {
      transform: translateY(0);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.45);
    }
    .btn-ghost {
      border: 1px solid var(--border-soft);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-sub);
    }
    .btn-ghost:hover {
      border-color: var(--accent);
      color: var(--text-main);
    }

    .small-hint {
      font-size: 11px;
      color: var(--text-sub);
      line-height: 1.6;
      margin-top: 4px;
    }

    .card-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: calc(100vh - 150px);
      overflow-y: auto;
      padding-right: 2px;
    }
    @media (max-width: 767px) {
      .card-list { max-height: none; }
    }
    .card {
      border-radius: 12px;
      border: 1px solid var(--border-soft);
      background: rgba(15, 23, 42, 0.9);
      padding: 9px 10px 9px;
      font-size: 13px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .card-header-line {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 4px;
    }
    .card-title {
      font-size: 13px;
      font-weight: 560;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .card-meta {
      font-size: 11px;
      color: var(--text-sub);
      white-space: nowrap;
    }
    .card-content {
      font-size: 13px;
      line-height: 1.6;
      max-height: 4.4em;
      overflow: hidden;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .card-footer {
      display: flex;
      flex-wrap: wrap;
      justify-content: flex-end;
      gap: 4px;
      margin-top: 4px;
    }
    .btn-small {
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: transparent;
      color: var(--text-sub);
      font-size: 11px;
      padding: 3px 8px;
      cursor: pointer;
    }
    .btn-small:hover {
      border-color: var(--accent);
      color: var(--text-main);
    }
    .btn-small-danger {
      border-color: rgba(248, 113, 113, 0.6);
      color: #fecaca;
    }
    .empty-hint {
      font-size: 12px;
      color: var(--text-sub);
      padding: 6px 4px;
    }

    .footer-info {
      margin-top: 10px;
      font-size: 11px;
      color: var(--text-sub);
      line-height: 1.6;
    }

    /* 模态框 */
    .modal-wrap {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.78);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
      padding: 10px;
    }
    .modal-wrap.show {
      display: flex;
    }
    .modal {
      width: 100%;
      max-width: 580px;
      max-height: 90vh;
      overflow-y: auto;
      background: #020617;
      border-radius: 14px;
      border: 1px solid var(--border-soft);
      padding: 12px 13px 13px;
    }
    .modal-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 6px;
    }
    .modal-desc {
      font-size: 12px;
      color: var(--text-sub);
      line-height: 1.6;
      margin-bottom: 8px;
    }
    .modal-field {
      margin-bottom: 8px;
    }
    .modal-label {
      font-size: 12px;
      margin-bottom: 2px;
    }
    .modal-input, .modal-textarea, .modal-select {
      width: 100%;
      border-radius: 8px;
      border: 1px solid var(--border-soft);
      background: rgba(15, 23, 42, 0.98);
      color: var(--text-main);
      padding: 6px 8px;
      font-size: 13px;
    }
    .modal-textarea {
      min-height: 80px;
      resize: vertical;
      line-height: 1.6;
    }
    .modal-btn-row {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      margin-top: 4px;
      flex-wrap: wrap;
    }
    .btn-secondary, .btn-primary {
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      padding: 6px 14px;
      font-size: 13px;
      cursor: pointer;
      background: transparent;
      color: var(--text-sub);
    }
    .btn-secondary:hover {
      border-color: var(--accent);
      color: var(--text-main);
    }
    .btn-primary {
      border-color: var(--accent);
      background: linear-gradient(135deg, var(--accent), #4ade80);
      color: #022c22;
      font-weight: 560;
    }
    .btn-primary:hover {
      filter: brightness(1.05);
    }

    /* 听音写谱专用 */
    .tone-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 6px;
      font-size: 13px;
    }
    .tone-label {
      font-size: 12px;
    }
    .melody-display {
      font-family: "SF Mono", Menlo, Consolas, monospace;
      font-size: 13px;
      background: rgba(15, 23, 42, 0.98);
      border-radius: 8px;
      border: 1px solid var(--border-soft);
      padding: 6px 8px;
      min-height: 40px;
      line-height: 1.6;
      white-space: pre-wrap;
      word-break: break-word;
      margin-bottom: 6px;
    }
    .melody-pad {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 6px;
      margin-bottom: 6px;
    }
    .btn-pad {
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: rgba(15, 23, 42, 0.96);
      color: var(--text-main);
      font-size: 13px;
      padding: 6px 0;
      cursor: pointer;
    }
    .btn-pad:hover {
      border-color: var(--accent);
    }
  </style>
</head>
<body>
  <main class="app">
    <header class="top-bar">
      <div>
        <div class="top-title">老年工作室</div>
        <div class="top-subtitle">用记录，留住越过的痕迹。</div>
      </div>
      <div class="avatar">
        <div class="avatar-circle">师</div>
        <div>
          <div class="avatar-text-main">工作室老师</div>
          <div class="avatar-text-sub">你是这里的主人</div>
        </div>
      </div>
    </header>

    <section class="studio-tabs">
      <button class="studio-tab" data-studio="life"><span>生活</span></button>
      <button class="studio-tab" data-studio="art"><span>艺术</span></button>
      <button class="studio-tab" data-studio="idea"><span>思想</span></button>
      <button class="studio-tab" data-studio="tech"><span>技术</span></button>
    </section>

    <section class="layout">
      <div class="panel panel-left">
        <div class="studio-name" id="studioName">生活工作室</div>
        <div class="studio-fullname" id="studioFullName">精彩生活 / 温馨回忆</div>
        <div class="studio-desc" id="studioDesc">
          随手记一件这一次想留住的小事，不用写长篇，慢慢也会积累出一份可以翻看的生活记录。
        </div>

        <div class="btn-row" id="studioButtons">
          <!-- 按当前工作室渲染按钮 -->
        </div>

        <div class="small-hint" id="studioHint">
          提示：每一张卡片都是一块小砖，写完可以放一放，以后再回来接着补。
        </div>
      </div>

      <div class="panel panel-right">
        <div class="card-list" id="cardList"></div>
        <div class="empty-hint" id="emptyHint" style="display:none;">
          这一间还空着，可以先新建一张卡片试一试。
        </div>
        <div class="footer-info">
          说明：这里只帮你记录和整理，不做医疗、理财、法律等决策。需要专业意见时，请线下咨询医生、律师或理财人员。
        </div>
      </div>
    </section>
  </main>

  <!-- 新建 / 编辑卡片 -->
  <div class="modal-wrap" id="modalEdit">
    <div class="modal">
      <div class="modal-title" id="modalEditTitle">编辑卡片</div>
      <div class="modal-field">
        <div class="modal-label">标题（可留空）</div>
        <input id="editTitle" class="modal-input" placeholder="给这张卡片起个名字（可不填）" />
      </div>
      <div class="modal-field">
        <div class="modal-label">内容</div>
        <textarea id="editContent" class="modal-textarea" placeholder="可以分段写，慢慢补。"></textarea>
      </div>
      <div class="modal-btn-row">
        <button class="btn-secondary" onclick="closeModal('modalEdit')">取消</button>
        <button class="btn-primary" onclick="saveEdit()">保存</button>
      </div>
    </div>
  </div>

  <!-- 生活：这一次小卡 -->
  <div class="modal-wrap" id="modalOnce">
    <div class="modal">
      <div class="modal-title">这一次小卡</div>
      <div class="modal-desc">
        不按“今天”“打卡”来算，只是记一件这一次想留住的小事，写完就放在这里等你以后再看。
      </div>
      <div class="modal-field">
        <div class="modal-label">这一次，我想记住的一件小事：</div>
        <textarea id="onceEvent" class="modal-textarea" placeholder="例如：跟谁、在哪儿、发生了什么。"></textarea>
      </div>
      <div class="modal-field">
        <div class="modal-label">这件事里，让我最在意的一个细节：</div>
        <textarea id="onceDetail" class="modal-textarea" placeholder="一句话、一个表情、一段对话都行。"></textarea>
      </div>
      <div class="modal-field">
        <div class="modal-label">以后再看到这张卡时，我希望自己能想起：</div>
        <textarea id="onceFuture" class="modal-textarea" placeholder="写一句话给以后再看到这张卡的自己。"></textarea>
      </div>
      <div class="modal-btn-row">
        <button class="btn-secondary" onclick="closeModal('modalOnce')">取消</button>
        <button class="btn-primary" onclick="submitOnceCard()">生成卡片</button>
      </div>
    </div>
  </div>

  <!-- 生活：补一补细节 -->
  <div class="modal-wrap" id="modalDetail">
    <div class="modal">
      <div class="modal-title">补一补细节</div>
      <div class="modal-desc">
        只是在原来内容的基础上补几笔，让这件事以后更好回忆。不会改动你之前写的部分。
      </div>
      <div class="modal-field">
        <div class="modal-label">大概是哪个阶段？（年龄 / 年代 / 大致年份）</div>
        <input id="detailWhen" class="modal-input" placeholder="例如：25 岁左右 / 90 年代初 / 2010 年前后…" />
      </div>
      <div class="modal-field">
        <div class="modal-label">主要是在什么地方 / 环境？</div>
        <input id="detailWhere" class="modal-input" placeholder="城市、乡镇，或单位类型，例如：油田、学校、公司…" />
      </div>
      <div class="modal-field">
        <div class="modal-label">如果要挑一件最典型的小事，是什么？</div>
        <textarea id="detailEvent" class="modal-textarea" placeholder="用两三句话写一写。"></textarea>
      </div>
      <div class="modal-btn-row">
        <button class="btn-secondary" onclick="closeModal('modalDetail')">取消</button>
        <button class="btn-primary" onclick="submitDetail()">添加到这张卡</button>
      </div>
    </div>
  </div>

  <!-- 艺术：记录一段旋律 -->
  <div class="modal-wrap" id="modalMelody">
    <div class="modal">
      <div class="modal-title">记录一段旋律</div>
      <div class="modal-desc">
        不需要专业，只是把你哼出来的旋律，先记成简谱数字，留一份种子在这里。
      </div>
      <div class="modal-field">
        <div class="tone-row">
          <span class="tone-label">调性：</span>
          <select id="melodyKey" class="modal-select">
            <option value="C">C 调</option>
            <option value="D">D 调</option>
            <option value="E">E 调</option>
            <option value="F">F 调</option>
            <option value="G">G 调</option>
            <option value="A">A 调</option>
            <option value="B">B 调</option>
          </select>
        </div>
      </div>
      <div class="modal-field">
        <div class="modal-label">当前简谱：</div>
        <div id="melodyDisplay" class="melody-display">（点击下面的数字按钮开始记录）</div>
      </div>
      <div class="modal-field">
        <div class="modal-label">点击数字按钮记录音高：</div>
        <div class="melody-pad">
          <button class="btn-pad" onclick="addMelody('1')">1</button>
          <button class="btn-pad" onclick="addMelody('2')">2</button>
          <button class="btn-pad" onclick="addMelody('3')">3</button>
          <button class="btn-pad" onclick="addMelody('4')">4</button>
          <button class="btn-pad" onclick="addMelody('5')">5</button>
          <button class="btn-pad" onclick="addMelody('6')">6</button>
          <button class="btn-pad" onclick="addMelody('7')">7</button>
          <button class="btn-pad" onclick="addMelody('.')">·</button>
          <button class="btn-pad" onclick="melodyBackspace()">退格</button>
          <button class="btn-pad" onclick="melodyClear()">清空</button>
        </div>
      </div>
      <div class="modal-field">
        <div class="modal-label">简单写一句当时的场景或心情（可选）：</div>
        <textarea id="melodyNote" class="modal-textarea" placeholder="例如：晚上在阳台随手哼的一个小调子。"></textarea>
      </div>
      <div class="modal-btn-row">
        <button class="btn-secondary" onclick="closeModal('modalMelody')">取消</button>
        <button class="btn-primary" onclick="submitMelody()">保存为卡片</button>
      </div>
    </div>
  </div>

  <!-- 艺术：小说骨架（三问） -->
  <div class="modal-wrap" id="modalStory">
    <div class="modal">
      <div class="modal-title">小说骨架 · 三问</div>
      <div class="modal-desc">
        先不用写长篇，只是把这一篇的大致骨架搭出来，后面你可以慢慢往里填。
      </div>
      <div class="modal-field">
        <div class="modal-label">这一次想写的是：</div>
        <input id="storyWhat" class="modal-input" placeholder="一个人 / 一件事 / 一段关系 / 一次改变…" />
      </div>
      <div class="modal-field">
        <div class="modal-label">大概发生在什么时候、什么地方？</div>
        <textarea id="storyWhenWhere" class="modal-textarea" placeholder="例如：90 年代初，在东营的一家小饭馆里…"></textarea>
      </div>
      <div class="modal-field">
        <div class="modal-label">我最想写清楚的冲突或心情是什么？</div>
        <textarea id="storyConflict" class="modal-textarea" placeholder="例如：那次谈话之后，我对自己整个人生的看法变了。"></textarea>
      </div>
      <div class="modal-btn-row">
        <button class="btn-secondary" onclick="closeModal('modalStory')">取消</button>
        <button class="btn-primary" onclick="submitStory()">生成骨架卡</button>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = "lt_elder_cards_v06";
    const STUDIO_CONFIG = {
      life: {
        name: "生活工作室",
        fullName: "精彩生活 / 温馨回忆",
        desc: "随手记一件这一次想留住的小事，不用写长篇，慢慢也会积累出一份可以翻看的生活记录。",
        hint: "可以从一件小事开始：今天或最近发生，让你有点在意的那一次。",
        buttons: [
          { type: "main", label: "新建卡片", handler: "openNewCard" },
          { type: "ghost", label: "随手记一张小卡", handler: "openOnceModal" }
        ]
      },
      art: {
        name: "张扬艺术工作室",
        fullName: "作品 · 旋律 · 小说骨架",
        desc: "写诗、记旋律、留作品草稿，不要求完美，只是让这些东西有一个被安放的地方。",
        hint: "哪怕只写一句、记一小段旋律，也比完全没留下要好得多。",
        buttons: [
          { type: "main", label: "新建作品卡", handler: "openNewCard" },
          { type: "ghost", label: "记录一段旋律", handler: "openMelodyModal" },
          { type: "ghost", label: "小说骨架（三问）", handler: "openStoryModal" }
        ]
      },
      idea: {
        name: "理论思想工作室",
        fullName: "人生观 / 教育观 / 信仰体会",
        desc: "把对人生、教育、社团或信仰的想法写清楚，不求统一标准，只给自己一个条理分明的版本。",
        hint: "可以从一个小主题开始：比如“钱”“孩子”“工作”“信仰中的某一个问题”。",
        buttons: [
          { type: "main", label: "新建卡片", handler: "openNewCard" }
        ]
      },
      tech: {
        name: "技术传承工作室",
        fullName: "项目经验 / 技术备忘录",
        desc: "一生做过的项目、积累的技术经验，可以慢慢拆成一张张卡片，留给后来人参考。",
        hint: "可以先写一件你最想留下的项目，再慢慢把细节补进去。",
        buttons: [
          { type: "main", label: "新建卡片", handler: "openNewCard" }
        ]
      }
    };

    let cards = [];
    let currentStudio = "life";
    let editingCardId = null;
    let detailTargetId = null;
    let melodyBuffer = "";

    function loadCards() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        const arr = JSON.parse(raw);
        if (Array.isArray(arr)) return arr;
      } catch (e) {}
      return [];
    }

    function saveCards() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(cards));
      } catch (e) {}
    }

    function formatTime(ts) {
      try {
        const d = new Date(ts);
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const day = String(d.getDate()).padStart(2, "0");
        const hh = String(d.getHours()).padStart(2, "0");
        const mm = String(d.getMinutes()).padStart(2, "0");
        return `${y}-${m}-${day} ${hh}:${mm}`;
      } catch (e) {
        return "";
      }
    }

    function setCurrentStudio(studio) {
      if (!STUDIO_CONFIG[studio]) studio = "life";
      currentStudio = studio;

      // tab 高亮
      document.querySelectorAll(".studio-tab").forEach(btn => {
        const s = btn.dataset.studio;
        btn.classList.toggle("active", s === studio);
      });

      // 左侧信息
      const conf = STUDIO_CONFIG[studio];
      document.getElementById("studioName").textContent = conf.name;
      document.getElementById("studioFullName").textContent = conf.fullName;
      document.getElementById("studioDesc").textContent = conf.desc;
      document.getElementById("studioHint").textContent = conf.hint;

      const btnRow = document.getElementById("studioButtons");
      btnRow.innerHTML = "";
      conf.buttons.forEach(b => {
        const el = document.createElement("button");
        el.className = b.type === "main" ? "btn-main" : "btn-ghost";
        el.textContent = b.label;
        el.addEventListener("click", () => {
          if (b.handler === "openNewCard") {
            openNewCard();
          } else if (b.handler === "openOnceModal") {
            openOnceModal();
          } else if (b.handler === "openMelodyModal") {
            openMelodyModal();
          } else if (b.handler === "openStoryModal") {
            openStoryModal();
          }
        });
        btnRow.appendChild(el);
      });

      renderCardList();
    }

    function renderCardList() {
      const listEl = document.getElementById("cardList");
      listEl.innerHTML = "";
      const studioCards = cards
        .filter(c => c.studio === currentStudio)
        .sort((a, b) => b.createdAt - a.createdAt);
      const emptyHint = document.getElementById("emptyHint");
      if (studioCards.length === 0) {
        emptyHint.style.display = "block";
        return;
      } else {
        emptyHint.style.display = "none";
      }

      studioCards.forEach(card => {
        const cardEl = document.createElement("div");
        cardEl.className = "card";

        const headerLine = document.createElement("div");
        headerLine.className = "card-header-line";

        const titleEl = document.createElement("div");
        titleEl.className = "card-title";
        titleEl.textContent = card.title || "未命名卡片";

        const metaEl = document.createElement("div");
        metaEl.className = "card-meta";
        metaEl.textContent = formatTime(card.createdAt);

        headerLine.appendChild(titleEl);
        headerLine.appendChild(metaEl);

        const contentEl = document.createElement("div");
        contentEl.className = "card-content";
        contentEl.textContent = (card.content || "").trim();

        const footer = document.createElement("div");
        footer.className = "card-footer";

        const btnEdit = document.createElement("button");
        btnEdit.className = "btn-small";
        btnEdit.textContent = "打开 / 编辑";
        btnEdit.addEventListener("click", () => openEdit(card.id));
        footer.appendChild(btnEdit);

        if (currentStudio === "life") {
          const btnDetail = document.createElement("button");
          btnDetail.className = "btn-small";
          btnDetail.textContent = "补一补细节";
          btnDetail.addEventListener("click", () => openDetailModal(card.id));
          footer.appendChild(btnDetail);
        }

        const btnDelete = document.createElement("button");
        btnDelete.className = "btn-small btn-small-danger";
        btnDelete.textContent = "删除";
        btnDelete.addEventListener("click", () => deleteCard(card.id));
        footer.appendChild(btnDelete);

        cardEl.appendChild(headerLine);
        cardEl.appendChild(contentEl);
        cardEl.appendChild(footer);

        listEl.appendChild(cardEl);
      });
    }

    function openNewCard() {
      editingCardId = null;
      document.getElementById("modalEditTitle").textContent = "新建卡片";
      document.getElementById("editTitle").value = "";
      document.getElementById("editContent").value = "";
      openModal("modalEdit");
    }

    function openEdit(id) {
      const card = cards.find(c => c.id === id);
      if (!card) return;
      editingCardId = id;
      document.getElementById("modalEditTitle").textContent = "编辑卡片";
      document.getElementById("editTitle").value = card.title || "";
      document.getElementById("editContent").value = card.content || "";
      openModal("modalEdit");
    }

    function saveEdit() {
      const title = document.getElementById("editTitle").value.trim();
      const content = document.getElementById("editContent").value;
      if (!content.trim()) {
        alert("至少写一点内容，再保存这张卡片。");
        return;
      }
      const now = Date.now();
      if (editingCardId) {
        const idx = cards.findIndex(c => c.id === editingCardId);
        if (idx >= 0) {
          cards[idx] = {
            ...cards[idx],
            title,
            content,
            updatedAt: now
          };
        }
      } else {
        const id = "c_" + now + "_" + Math.random().toString(16).slice(2);
        cards.push({
          id,
          studio: currentStudio,
          title,
          content,
          createdAt: now,
          updatedAt: now,
          templateType: "plain"
        });
      }
      saveCards();
      closeModal("modalEdit");
      renderCardList();
    }

    function deleteCard(id) {
      if (!confirm("确定要删除这张卡片吗？这一步目前不能撤销。")) return;
      cards = cards.filter(c => c.id !== id);
      saveCards();
      renderCardList();
    }

    function openModal(id) {
      const el = document.getElementById(id);
      if (el) el.classList.add("show");
    }
    function closeModal(id) {
      const el = document.getElementById(id);
      if (el) el.classList.remove("show");
      if (id === "modalDetail") {
        detailTargetId = null;
      } else if (id === "modalMelody") {
        melodyBuffer = "";
        updateMelodyDisplay();
      }
    }

    // 生活：这一次小卡
    function openOnceModal() {
      document.getElementById("onceEvent").value = "";
      document.getElementById("onceDetail").value = "";
      document.getElementById("onceFuture").value = "";
      openModal("modalOnce");
    }

    function submitOnceCard() {
      const e1 = document.getElementById("onceEvent").value.trim();
      const e2 = document.getElementById("onceDetail").value.trim();
      const e3 = document.getElementById("onceFuture").value.trim();
      if (!e1 && !e2 && !e3) {
        alert("至少写一点内容，再生成这张小卡。");
        return;
      }
      const now = Date.now();
      let content = "【这一次】\n";
      if (e1) content += "· 我想记住的一件小事：\n" + e1 + "\n\n";
      if (e2) content += "· 让我在意的一个细节：\n" + e2 + "\n\n";
      if (e3) content += "· 以后再看到时，希望自己能想起：\n" + e3 + "\n";
      const title = "这一次小卡";
      const id = "c_" + now + "_" + Math.random().toString(16).slice(2);
      cards.push({
        id,
        studio: "life",
        title,
        content,
        createdAt: now,
        updatedAt: now,
        templateType: "once_note"
      });
      saveCards();
      closeModal("modalOnce");
      setCurrentStudio("life");
    }

    // 生活：补一补细节
    function openDetailModal(cardId) {
      detailTargetId = cardId;
      document.getElementById("detailWhen").value = "";
      document.getElementById("detailWhere").value = "";
      document.getElementById("detailEvent").value = "";
      openModal("modalDetail");
    }

    function submitDetail() {
      if (!detailTargetId) {
        closeModal("modalDetail");
        return;
      }
      const w = document.getElementById("detailWhen").value.trim();
      const where = document.getElementById("detailWhere").value.trim();
      const ev = document.getElementById("detailEvent").value.trim();
      if (!w && !where && !ev) {
        alert("可以只写一两项，但不能全部空着。");
        return;
      }
      const idx = cards.findIndex(c => c.id === detailTargetId);
      if (idx < 0) {
        closeModal("modalDetail");
        return;
      }
      let extra = "\n\n【补充细节】\n";
      if (w) extra += "· 大概的阶段：\n" + w + "\n\n";
      if (where) extra += "· 所在的地方 / 环境：\n" + where + "\n\n";
      if (ev) extra += "· 一件最典型的小事：\n" + ev + "\n";
      cards[idx] = {
        ...cards[idx],
        content: (cards[idx].content || "") + extra,
        updatedAt: Date.now()
      };
      saveCards();
      closeModal("modalDetail");
      renderCardList();
    }

    // 艺术：记录旋律
    function openMelodyModal() {
      melodyBuffer = "";
      updateMelodyDisplay();
      document.getElementById("melodyKey").value = "C";
      document.getElementById("melodyNote").value = "";
      openModal("modalMelody");
    }

    function updateMelodyDisplay() {
      const el = document.getElementById("melodyDisplay");
      if (!el) return;
      const trimmed = melodyBuffer.trim();
      el.textContent = trimmed || "（点击下面的数字按钮开始记录）";
    }

    function addMelody(sym) {
      melodyBuffer = (melodyBuffer + " " + sym).trim();
      updateMelodyDisplay();
    }

    function melodyBackspace() {
      if (!melodyBuffer) return;
      const parts = melodyBuffer.trim().split(/\s+/);
      parts.pop();
      melodyBuffer = parts.join(" ");
      updateMelodyDisplay();
    }

    function melodyClear() {
      melodyBuffer = "";
      updateMelodyDisplay();
    }

    function submitMelody() {
      const seq = melodyBuffer.trim();
      if (!seq) {
        alert("先用数字按钮记一点旋律，再保存。");
        return;
      }
      const key = document.getElementById("melodyKey").value || "C";
      const note = document.getElementById("melodyNote").value.trim();
      const now = Date.now();
      let content = `【旋律草稿】\n· 调性：${key} 调\n· 简谱：\n${seq}\n`;
      if (note) {
        content += "\n· 场景 / 心情备注：\n" + note + "\n";
      }
      const title = "旋律草稿";
      const id = "c_" + now + "_" + Math.random().toString(16).slice(2);
      cards.push({
        id,
        studio: "art",
        title,
        content,
        createdAt: now,
        updatedAt: now,
        templateType: "melody_seed"
      });
      saveCards();
      closeModal("modalMelody");
      setCurrentStudio("art");
    }

    // 艺术：小说骨架
    function openStoryModal() {
      document.getElementById("storyWhat").value = "";
      document.getElementById("storyWhenWhere").value = "";
      document.getElementById("storyConflict").value = "";
      openModal("modalStory");
    }

    function submitStory() {
      const w = document.getElementById("storyWhat").value.trim();
      const ww = document.getElementById("storyWhenWhere").value.trim();
      const cf = document.getElementById("storyConflict").value.trim();
      if (!w && !ww && !cf) {
        alert("至少写一点，再生成骨架卡。");
        return;
      }
      const now = Date.now();
      let content = "【小说骨架】\n";
      if (w) content += "· 想写的是：\n" + w + "\n\n";
      if (ww) content += "· 发生的时间 / 地方：\n" + ww + "\n\n";
      if (cf) content += "· 最想写清楚的冲突 / 心情：\n" + cf + "\n";
      const title = "小说骨架";
      const id = "c_" + now + "_" + Math.random().toString(16).slice(2);
      cards.push({
        id,
        studio: "art",
        title,
        content,
        createdAt: now,
        updatedAt: now,
        templateType: "story_skeleton"
      });
      saveCards();
      closeModal("modalStory");
      setCurrentStudio("art");
    }

    document.addEventListener("DOMContentLoaded", () => {
      cards = loadCards();
      document.querySelectorAll(".studio-tab").forEach(btn => {
        btn.addEventListener("click", () => {
          const s = btn.dataset.studio;
          setCurrentStudio(s);
        });
      });
      setCurrentStudio(currentStudio);
    });
  </script>
</body>
</html>
