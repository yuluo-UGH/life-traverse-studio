<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>è€å¹´å·¥ä½œå®¤ Â· LifeTraverse v0.7 æœ¬åœ°ç‰ˆ</title>
  <style>
    :root {
      color-scheme: dark;
      --bg: #020617;
      --card: #020617;
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.12);
      --text-main: #f9fafb;
      --text-sub: #9ca3af;
      --border-soft: #1f2937;
      --danger: #f97373;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "PingFang SC", "Microsoft YaHei", sans-serif;
      background: radial-gradient(circle at top, #020617 0, #000 80%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      justify-content: center;
    }
    .app {
      width: 100%;
      max-width: 960px;
      padding: 16px 12px 72px; /* åº•éƒ¨å¯¼èˆªç•™ç©ºé—´ */
    }
    @media (min-width: 768px) {
      .app { padding: 20px 16px 80px; }
    }
    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    .top-left {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .back-link {
      align-self: flex-start;
      border: none;
      background: transparent;
      color: var(--text-sub);
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      cursor: pointer;
      border: 1px solid transparent;
      margin-bottom: 2px;
    }
    .back-link:hover {
      border-color: var(--border-soft);
      color: var(--text-main);
    }
    .top-title {
      font-size: 18px;
      font-weight: 650;
    }
    .top-subtitle {
      font-size: 12px;
      color: var(--text-sub);
      margin-top: 2px;
    }
    .avatar {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: default;
    }
    .avatar-circle {
      width: 30px;
      height: 30px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #22c55e, #0b1120);
      border: 1px solid rgba(248, 250, 252, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: 600;
    }
    .avatar-text-main {
      font-size: 13px;
      font-weight: 600;
    }
    .avatar-text-sub {
      font-size: 11px;
      color: var(--text-sub);
    }

    /* è§†å›¾åˆ‡æ¢ */
    .view-tabs {
      display: inline-flex;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: rgba(15, 23, 42, 0.96);
      padding: 2px;
      margin-bottom: 8px;
      margin-top: 2px;
    }
    .view-tab-btn {
      border-radius: 999px;
      border: none;
      background: transparent;
      font-size: 11px;
      padding: 4px 10px;
      color: var(--text-sub);
      cursor: pointer;
      white-space: nowrap;
    }
    .view-tab-btn.active {
      background: radial-gradient(circle at top, var(--accent-soft), rgba(15, 23, 42, 0.96));
      color: var(--text-main);
    }

    /* ç®€æ˜“å…¥å£ */
    .simple-view {
      margin-top: 4px;
    }
    .panel {
      background: rgba(15, 23, 42, 0.96);
      border-radius: 14px;
      border: 1px solid var(--border-soft);
      padding: 10px 11px 11px;
    }
    @media (min-width: 768px) {
      .panel { padding: 12px 13px 13px; }
    }
    .simple-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .simple-subtitle {
      font-size: 12px;
      color: var(--text-sub);
      margin-bottom: 10px;
    }
    .simple-btn-row {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 10px;
    }
    @media (min-width: 600px) {
      .simple-btn-row {
        flex-direction: row;
      }
    }
    .simple-main-btn {
      flex: 1;
      border-radius: 16px;
      border: 1px solid var(--border-soft);
      background: rgba(15, 23, 42, 0.98);
      padding: 10px 10px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 4px;
      transition: border-color 0.12s ease-out, background 0.12s ease-out, transform 0.08s ease-out;
    }
    .simple-main-btn:hover {
      border-color: var(--accent);
      transform: translateY(-1px);
    }
    .simple-main-btn-title {
      font-size: 14px;
      font-weight: 560;
    }
    .simple-main-btn-desc {
      font-size: 12px;
      color: var(--text-sub);
      line-height: 1.6;
    }
    .simple-section-title {
      font-size: 13px;
      font-weight: 560;
      margin: 6px 0 4px;
    }
    .simple-recent-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 6px;
    }
    .simple-recent-item {
      display: flex;
      align-items: baseline;
      gap: 6px;
      font-size: 12px;
      cursor: pointer;
      padding: 4px 4px;
      border-radius: 8px;
      transition: background 0.12s ease-out;
    }
    .simple-recent-item:hover {
      background: rgba(15, 23, 42, 0.9);
    }
    .simple-recent-icon {
      font-size: 14px;
    }
    .simple-recent-main {
      flex: 1;
      min-width: 0;
    }
    .simple-recent-title-text {
      font-size: 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .simple-recent-meta {
      font-size: 11px;
      color: var(--text-sub);
      white-space: nowrap;
    }
    .simple-hint {
      font-size: 11px;
      color: var(--text-sub);
      line-height: 1.6;
      margin-top: 4px;
    }
    .simple-hint button {
      border: none;
      background: transparent;
      color: var(--accent);
      text-decoration: underline;
      font-size: 11px;
      cursor: pointer;
      padding: 0 2px;
    }

    /* å·¥ä½œå®¤è§†å›¾å¸ƒå±€ */
    .layout {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 4px;
    }
    @media (min-width: 768px) {
      .layout {
        flex-direction: row;
        align-items: flex-start;
      }
    }
    .panel-left {
      flex: 0 0 280px;
    }
    .panel-right {
      flex: 1;
      min-width: 0;
    }

    .studio-name {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .studio-fullname {
      font-size: 12px;
      color: var(--text-sub);
      margin-bottom: 8px;
    }
    .studio-desc {
      font-size: 13px;
      color: var(--text-sub);
      line-height: 1.7;
      margin-bottom: 8px;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 4px;
    }
    .btn-main, .btn-ghost {
      border-radius: 999px;
      border: none;
      font-size: 13px;
      padding: 7px 14px;
      cursor: pointer;
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      transition: background 0.12s ease-out, color 0.12s ease-out, border-color 0.12s ease-out, transform 0.08s ease-out;
    }
    .btn-main {
      background: linear-gradient(135deg, var(--accent), #4ade80);
      color: #022c22;
      font-weight: 560;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
    }
    .btn-main:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 22px rgba(0, 0, 0, 0.45);
    }
    .btn-main:active {
      transform: translateY(0);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.45);
    }
    .btn-ghost {
      border: 1px solid var(--border-soft);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-sub);
    }
    .btn-ghost:hover {
      border-color: var(--accent);
      color: var(--text-main);
    }

    .small-hint {
      font-size: 11px;
      color: var(--text-sub);
      line-height: 1.6;
      margin-top: 4px;
    }

    .tag-search-btn {
      margin-top: 6px;
      font-size: 11px;
      padding: 4px 10px;
    }

    .card-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: calc(100vh - 190px);
      overflow-y: auto;
      padding-right: 2px;
    }
    @media (max-width: 767px) {
      .card-list { max-height: none; }
    }
    .card {
      border-radius: 12px;
      border: 1px solid var(--border-soft);
      background: rgba(15, 23, 42, 0.9);
      padding: 9px 10px 9px;
      font-size: 13px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .card-header-line {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 4px;
    }
    .card-title {
      font-size: 13px;
      font-weight: 560;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .card-type-icon {
      font-size: 13px;
    }
    .card-meta {
      font-size: 11px;
      color: var(--text-sub);
      white-space: nowrap;
    }
    .card-content {
      font-size: 13px;
      line-height: 1.6;
      max-height: 4.4em;
      overflow: hidden;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .card-image {
      max-height: 140px;
      border-radius: 10px;
      margin-bottom: 4px;
      width: 100%;
      object-fit: cover;
    }
    .card-tags {
      font-size: 11px;
      color: var(--text-sub);
      margin-top: 2px;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }
    .card-tag-chip {
      padding: 1px 6px;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
    }
    .card-footer {
      display: flex;
      flex-wrap: wrap;
      justify-content: flex-end;
      gap: 4px;
      margin-top: 4px;
    }
    .btn-small {
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: transparent;
      color: var(--text-sub);
      font-size: 11px;
      padding: 3px 8px;
      cursor: pointer;
    }
    .btn-small:hover {
      border-color: var(--accent);
      color: var(--text-main);
    }
    .btn-small-danger {
      border-color: rgba(248, 113, 113, 0.6);
      color: #fecaca;
    }
    .empty-hint {
      font-size: 12px;
      color: var(--text-sub);
      padding: 6px 4px;
    }

    .tag-filter-info {
      font-size: 11px;
      color: var(--text-sub);
      margin-bottom: 4px;
      display: none;
    }
    .tag-filter-info button {
      border: none;
      background: transparent;
      color: var(--accent);
      text-decoration: underline;
      font-size: 11px;
      cursor: pointer;
      padding: 0 2px;
    }

    .footer-info {
      margin-top: 8px;
      font-size: 11px;
      color: var(--text-sub);
      line-height: 1.6;
    }
    .backup-bar {
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      justify-content: flex-end;
    }

    /* æ¨¡æ€æ¡† */
    .modal-wrap {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.78);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
      padding: 10px;
    }
    .modal-wrap.show {
      display: flex;
    }
    .modal {
      width: 100%;
      max-width: 580px;
      max-height: 90vh;
      overflow-y: auto;
      background: #020617;
      border-radius: 14px;
      border: 1px solid var(--border-soft);
      padding: 12px 13px 13px;
    }
    .modal-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 6px;
    }
    .modal-desc {
      font-size: 12px;
      color: var(--text-sub);
      line-height: 1.6;
      margin-bottom: 8px;
    }
    .modal-field {
      margin-bottom: 8px;
    }
    .modal-label {
      font-size: 12px;
      margin-bottom: 2px;
    }
    .modal-input, .modal-textarea, .modal-select {
      width: 100%;
      border-radius: 8px;
      border: 1px solid var(--border-soft);
      background: rgba(15, 23, 42, 0.98);
      color: var(--text-main);
      padding: 6px 8px;
      font-size: 13px;
    }
    .modal-textarea {
      min-height: 80px;
      resize: vertical;
      line-height: 1.6;
    }
    .modal-btn-row {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      margin-top: 4px;
      flex-wrap: wrap;
    }
    .btn-secondary, .btn-primary {
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      padding: 6px 14px;
      font-size: 13px;
      cursor: pointer;
      background: transparent;
      color: var(--text-sub);
    }
    .btn-secondary:hover {
      border-color: var(--accent);
      color: var(--text-main);
    }
    .btn-primary {
      border-color: var(--accent);
      background: linear-gradient(135deg, var(--accent), #4ade80);
      color: #022c22;
      font-weight: 560;
    }
    .btn-primary:hover {
      filter: brightness(1.05);
    }

    /* æ ‡ç­¾æŒ‰é’® */
    .tag-button-row {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }
    .tag-btn {
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: rgba(15, 23, 42, 0.98);
      color: var(--text-sub);
      font-size: 11px;
      padding: 3px 8px;
      cursor: pointer;
    }
    .tag-btn.tag-active {
      border-color: var(--accent);
      color: var(--text-main);
      background: rgba(34, 197, 94, 0.12);
    }

    /* å¬éŸ³å†™è°±ä¸“ç”¨ */
    .tone-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 6px;
      font-size: 13px;
    }
    .tone-label {
      font-size: 12px;
    }
    .melody-display {
      font-family: "SF Mono", Menlo, Consolas, monospace;
      font-size: 13px;
      background: rgba(15, 23, 42, 0.98);
      border-radius: 8px;
      border: 1px solid var(--border-soft);
      padding: 6px 8px;
      min-height: 40px;
      line-height: 1.6;
      white-space: pre-wrap;
      word-break: break-word;
      margin-bottom: 6px;
    }
    .melody-pad {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 6px;
      margin-bottom: 6px;
    }
    .btn-pad {
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: rgba(15, 23, 42, 0.96);
      color: var(--text-main);
      font-size: 13px;
      padding: 6px 0;
      cursor: pointer;
    }
    .btn-pad:hover {
      border-color: var(--accent);
    }

    /* åº•éƒ¨å¯¼èˆªæ¡ */
    .bottom-nav {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 10px;
      width: 100%;
      max-width: 960px;
      padding: 6px 10px;
      z-index: 40;
    }
    .bottom-nav-inner {
      border-radius: 999px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      background: rgba(15, 23, 42, 0.96);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 4px;
      padding: 4px;
    }
    .bottom-nav-btn {
      flex: 1;
      min-width: 0;
      border-radius: 999px;
      border: none;
      background: transparent;
      color: var(--text-sub);
      font-size: 12px;
      padding: 6px 4px;
      cursor: pointer;
      white-space: nowrap;
      transition: background 0.12s ease-out, color 0.12s ease-out;
    }
    .bottom-nav-btn.home {
      flex: 1.2;
    }
    .bottom-nav-btn.active {
      background: radial-gradient(circle at top, var(--accent-soft), rgba(15, 23, 42, 0.96));
      color: var(--text-main);
    }
  </style>
</head>
<body>
  <main class="app">
    <header class="top-bar">
      <div class="top-left">
        <button class="back-link" onclick="goHome()">â† å›å¤§å…</button>
        <div class="top-title">è€å¹´å·¥ä½œå®¤</div>
        <div class="top-subtitle">ç”¨è®°å½•ï¼Œé™ªä½ èµ°æ¥ä¸‹æ¥çš„è·¯ã€‚</div>
      </div>
      <div class="avatar">
        <div class="avatar-circle">å¸ˆ</div>
        <div>
          <div class="avatar-text-main">å·¥ä½œå®¤è€å¸ˆ</div>
          <div class="avatar-text-sub">ä½ æ˜¯è¿™é‡Œçš„ä¸»äºº</div>
        </div>
      </div>
    </header>

    <div class="view-tabs">
      <button class="view-tab-btn active" id="tabSimple" onclick="switchView('simple')">ç®€å•å…¥å£</button>
      <button class="view-tab-btn" id="tabStudio" onclick="switchView('studio')">å·¥ä½œå®¤è§†å›¾</button>
    </div>

    <!-- ç®€æ˜“å…¥å£è§†å›¾ -->
    <section class="simple-view" id="simpleView">
      <div class="panel">
        <div class="simple-title">ç®€å•å…¥å£ Â· éšæ‰‹å…ˆè®°ä¸‹æ¥</div>
        <div class="simple-subtitle">
          åˆ†ä¸æ¸…ç®—ç”Ÿæ´»è¿˜æ˜¯æŠ€æœ¯ä¹Ÿæ²¡å…³ç³»ï¼Œå…ˆè¯´ä¸€è¯´ã€å†™ä¸€å†™ï¼Œåé¢å¯ä»¥åœ¨å·¥ä½œå®¤é‡Œæ…¢æ…¢æ•´ç†ã€‚
        </div>

        <div class="simple-btn-row">
          <button class="simple-main-btn" onclick="openSimpleSay()">
            <div class="simple-main-btn-title">ğŸ™ è¯´ä¸€è¯´</div>
            <div class="simple-main-btn-desc">
              æ‰“å¼€å¤§è¾“å…¥æ¡†ï¼Œå¯ä»¥ç‚¹æ‰‹æœºé”®ç›˜ä¸Šçš„è¯­éŸ³æŒ‰é’®ï¼ˆğŸ¤ï¼‰ï¼Œè¾¹è¯´è¾¹è®°ã€‚
            </div>
          </button>
          <button class="simple-main-btn" onclick="openSimpleText()">
            <div class="simple-main-btn-title">âœ å†™ä¸€å°æ®µ</div>
            <div class="simple-main-btn-desc">
              åªå†™å‡ è¡Œå°±å¤Ÿäº†ï¼Œä»¥åå¯ä»¥åœ¨å·¥ä½œå®¤é‡Œæ…¢æ…¢è¡¥å……æˆä¸€ç¯‡å®Œæ•´çš„è®°å½•ã€‚
            </div>
          </button>
          <button class="simple-main-btn" onclick="openPhotoModal()">
            <div class="simple-main-btn-title">ğŸ“· æ‹ä¸€å¼ </div>
            <div class="simple-main-btn-desc">
              æ‹ä¸€å¼ ç…§ç‰‡æˆ–ä»ç›¸å†Œé€‰ä¸€å¼ ï¼ŒåŠ ä¸€å¥è¯´æ˜ï¼Œå­˜æˆä¸€å¼ â€œç…§ç‰‡å¡â€ã€‚ï¼ˆé€‚é‡ä½¿ç”¨å³å¯ï¼‰
            </div>
          </button>
        </div>

        <div class="simple-section-title">æœ€è¿‘çš„å‡ æ¡è®°å½•</div>
        <div id="simpleRecentList" class="simple-recent-list"></div>

        <div class="simple-hint">
          æç¤ºï¼šå¦‚æœä½ æ„¿æ„å¤šèŠ±ä¸€ç‚¹æ—¶é—´æ•´ç†ï¼Œå¯ä»¥
          <button onclick="switchView('studio')">å»å·¥ä½œå®¤è§†å›¾çœ‹çœ‹</button>ï¼Œ
          æŒ‰ç…§ç”Ÿæ´» / è‰ºæœ¯ / æ€æƒ³ / æŠ€æœ¯æ¥ç¿»é˜…ã€‚
        </div>
      </div>
    </section>

    <!-- å·¥ä½œå®¤è§†å›¾ -->
    <section class="layout" id="studioView" style="display:none;">
      <div class="panel panel-left">
        <div class="studio-name" id="studioName">ç”Ÿæ´»å·¥ä½œå®¤</div>
        <div class="studio-fullname" id="studioFullName">ç”Ÿæ´» & å›å¿†å·¥ä½œå®¤</div>
        <div class="studio-desc" id="studioDesc">
          éšæ‰‹è®°ä¸€ä»¶è¿™ä¸€æ¬¡æƒ³ç•™ä½çš„å°äº‹ï¼Œä¸ç”¨å†™é•¿ç¯‡ï¼Œæ…¢æ…¢ä¹Ÿä¼šç§¯ç´¯å‡ºä¸€ä»½å¯ä»¥ç¿»çœ‹çš„ç”Ÿæ´»è®°å½•å’Œå›å¿†å½•ã€‚
        </div>

        <div class="btn-row" id="studioButtons">
          <!-- æŒ‰å½“å‰å·¥ä½œå®¤æ¸²æŸ“æŒ‰é’® -->
        </div>

        <div class="small-hint" id="studioHint">
          æç¤ºï¼šå¯ä»¥ä»ä¸€ä»¶å°äº‹å¼€å§‹ï¼šæœ€è¿‘å‘ç”Ÿï¼Œè®©ä½ æœ‰ç‚¹åœ¨æ„çš„é‚£ä¸€æ¬¡ã€‚
        </div>

        <button class="btn-ghost tag-search-btn" onclick="openTagSearchModal()">æŒ‰æ ‡ç­¾æ‰¾ä¸€æ‰¾</button>
      </div>

      <div class="panel panel-right">
        <div class="tag-filter-info" id="tagFilterInfo">
          å½“å‰æŒ‰æ ‡ç­¾ç­›é€‰ï¼š
          <span id="tagFilterLabel"></span>
          <button onclick="clearTagFilter()">æ¸…é™¤ç­›é€‰</button>
        </div>
        <div class="card-list" id="cardList"></div>
        <div class="empty-hint" id="emptyHint" style="display:none;">
          è¿™ä¸€é—´è¿˜ç©ºç€ï¼Œå¯ä»¥å…ˆæ–°å»ºä¸€å¼ å¡ç‰‡è¯•ä¸€è¯•ã€‚
        </div>
        <div class="footer-info">
          è¯´æ˜ï¼šè¿™é‡Œåªå¸®ä½ è®°å½•å’Œæ•´ç†ï¼Œä¸åšåŒ»ç–—ã€ç†è´¢ã€æ³•å¾‹ã€å…»è€ç­‰å†³ç­–ã€‚éœ€è¦ä¸“ä¸šæ„è§æ—¶ï¼Œè¯·çº¿ä¸‹å’¨è¯¢åŒ»ç”Ÿã€å¾‹å¸ˆæˆ–ç†è´¢äººå‘˜ã€‚å½“å‰ç‰ˆæœ¬çš„æ•°æ®ä»…ä¿å­˜åœ¨è¿™ä¸€å°è®¾å¤‡ä¸Šã€‚
        </div>
        <div class="backup-bar">
          <button class="btn-small" onclick="exportBackup()">å¯¼å‡ºå¤‡ä»½</button>
          <button class="btn-small" onclick="triggerImport()">å¯¼å…¥å¤‡ä»½</button>
          <input type="file" id="importFile" accept="application/json" style="display:none" onchange="handleImportFile(event)" />
        </div>
      </div>
    </section>
  </main>

  <!-- åº•éƒ¨å¯¼èˆª -->
  <nav class="bottom-nav">
    <div class="bottom-nav-inner">
      <button class="bottom-nav-btn home" onclick="goHome()">å¤§å…</button>
      <button class="bottom-nav-btn" data-studio="life" onclick="switchStudio('life')">ç”Ÿæ´»</button>
      <button class="bottom-nav-btn" data-studio="art" onclick="switchStudio('art')">è‰ºæœ¯</button>
      <button class="bottom-nav-btn" data-studio="idea" onclick="switchStudio('idea')">æ€æƒ³</button>
      <button class="bottom-nav-btn" data-studio="tech" onclick="switchStudio('tech')">æŠ€æœ¯</button>
    </div>
  </nav>

  <!-- æ–°å»º / ç¼–è¾‘å¡ç‰‡ï¼ˆæ–‡å­—ç±»ï¼‰ -->
  <div class="modal-wrap" id="modalEdit">
    <div class="modal">
      <div class="modal-title" id="modalEditTitle">ç¼–è¾‘å¡ç‰‡</div>
      <div class="modal-field">
        <div class="modal-label">æ ‡é¢˜ï¼ˆå¯ç•™ç©ºï¼‰</div>
        <input id="editTitle" class="modal-input" placeholder="ç»™è¿™å¼ å¡ç‰‡èµ·ä¸ªåå­—ï¼ˆå¯ä¸å¡«ï¼‰" />
      </div>
      <div class="modal-field">
        <div class="modal-label">å†…å®¹</div>
        <textarea id="editContent" class="modal-textarea" placeholder="å¯ä»¥åˆ†æ®µå†™ï¼Œæ…¢æ…¢è¡¥ï¼›ä¸ä¼šæ‰“å­—ä¹Ÿå¯ä»¥ç”¨é”®ç›˜é‡Œçš„è¯­éŸ³è¾“å…¥ã€‚"></textarea>
      </div>
      <div class="modal-field">
        <div class="modal-label">å’Œè°æœ‰å…³ï¼Ÿï¼ˆå¯å¤šé€‰ï¼‰</div>
        <div id="editPersonTags" class="tag-button-row"></div>
      </div>
      <div class="modal-field">
        <div class="modal-label">å¤§æ¦‚æ˜¯å“ªä¸€ç±»äº‹ï¼Ÿï¼ˆå¯å¤šé€‰ï¼‰</div>
        <div id="editTopicTags" class="tag-button-row"></div>
      </div>
      <div class="modal-btn-row">
        <button class="btn-secondary" onclick="closeModal('modalEdit')">å–æ¶ˆ</button>
        <button class="btn-primary" onclick="saveEdit()">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- ç”Ÿæ´»ï¼šè¿™ä¸€æ¬¡å°å¡ -->
  <div class="modal-wrap" id="modalOnce">
    <div class="modal">
      <div class="modal-title">è¿™ä¸€æ¬¡å°å¡</div>
      <div class="modal-desc">
        ä¸æŒ‰â€œä»Šå¤©â€â€œæ‰“å¡â€æ¥ç®—ï¼Œåªæ˜¯è®°ä¸€ä»¶è¿™ä¸€æ¬¡æƒ³ç•™ä½çš„å°äº‹ï¼Œå†™å®Œå°±æ”¾åœ¨è¿™é‡Œç­‰ä½ ä»¥åå†çœ‹ã€‚
      </div>
      <div class="modal-field">
        <div class="modal-label">è¿™ä¸€æ¬¡ï¼Œæˆ‘æƒ³è®°ä½çš„ä¸€ä»¶å°äº‹ï¼š</div>
        <textarea id="onceEvent" class="modal-textarea" placeholder="ä¾‹å¦‚ï¼šè·Ÿè°ã€åœ¨å“ªå„¿ã€å‘ç”Ÿäº†ä»€ä¹ˆã€‚ä¹Ÿå¯ä»¥ç”¨è¯­éŸ³è¾“å…¥ã€‚"></textarea>
      </div>
      <div class="modal-field">
        <div class="modal-label">è¿™ä»¶äº‹é‡Œï¼Œè®©æˆ‘æœ€åœ¨æ„çš„ä¸€ä¸ªç»†èŠ‚ï¼š</div>
        <textarea id="onceDetail" class="modal-textarea" placeholder="ä¸€å¥è¯ã€ä¸€ä¸ªè¡¨æƒ…ã€ä¸€æ®µå¯¹è¯éƒ½è¡Œã€‚"></textarea>
      </div>
      <div class="modal-field">
        <div class="modal-label">ä»¥åå†çœ‹åˆ°è¿™å¼ å¡æ—¶ï¼Œæˆ‘å¸Œæœ›è‡ªå·±èƒ½æƒ³èµ·ï¼š</div>
        <textarea id="onceFuture" class="modal-textarea" placeholder="å†™ä¸€å¥è¯ç»™ä»¥åå†çœ‹åˆ°è¿™å¼ å¡çš„è‡ªå·±ã€‚"></textarea>
      </div>
      <div class="modal-btn-row">
        <button class="btn-secondary" onclick="closeModal('modalOnce')">å–æ¶ˆ</button>
        <button class="btn-primary" onclick="submitOnceCard()">ç”Ÿæˆå¡ç‰‡</button>
      </div>
    </div>
  </div>

  <!-- ç”Ÿæ´»ï¼šè¡¥ä¸€è¡¥ç»†èŠ‚ -->
  <div class="modal-wrap" id="modalDetail">
    <div class="modal">
      <div class="modal-title">è¡¥ä¸€è¡¥ç»†èŠ‚</div>
      <div class="modal-desc">
        åªæ˜¯åœ¨åŸæ¥å†…å®¹çš„åŸºç¡€ä¸Šè¡¥å‡ ç¬”ï¼Œè®©è¿™ä»¶äº‹ä»¥åæ›´å¥½å›å¿†ã€‚ä¸ä¼šæ”¹åŠ¨ä½ ä¹‹å‰å†™çš„éƒ¨åˆ†ã€‚
      </div>
      <div class="modal-field">
        <div class="modal-label">å¤§æ¦‚æ˜¯å“ªä¸ªé˜¶æ®µï¼Ÿï¼ˆå¹´é¾„ / å¹´ä»£ / å¤§è‡´å¹´ä»½ï¼‰</div>
        <input id="detailWhen" class="modal-input" placeholder="ä¾‹å¦‚ï¼š25 å²å·¦å³ / 90 å¹´ä»£åˆ / 2010 å¹´å‰åâ€¦" />
      </div>
      <div class="modal-field">
        <div class="modal-label">ä¸»è¦æ˜¯åœ¨ä»€ä¹ˆåœ°æ–¹ / ç¯å¢ƒï¼Ÿ</div>
        <input id="detailWhere" class="modal-input" placeholder="åŸå¸‚ã€ä¹¡é•‡ï¼Œæˆ–å•ä½ç±»å‹ï¼Œä¾‹å¦‚ï¼šæ²¹ç”°ã€å­¦æ ¡ã€å…¬å¸â€¦" />
      </div>
      <div class="modal-field">
        <div class="modal-label">å¦‚æœè¦æŒ‘ä¸€ä»¶æœ€å…¸å‹çš„å°äº‹ï¼Œæ˜¯ä»€ä¹ˆï¼Ÿ</div>
        <textarea id="detailEvent" class="modal-textarea" placeholder="ç”¨ä¸¤ä¸‰å¥è¯å†™ä¸€å†™ã€‚"></textarea>
      </div>
      <div class="modal-btn-row">
        <button class="btn-secondary" onclick="closeModal('modalDetail')">å–æ¶ˆ</button>
        <button class="btn-primary" onclick="submitDetail()">æ·»åŠ åˆ°è¿™å¼ å¡</button>
      </div>
    </div>
  </div>

  <!-- è‰ºæœ¯ï¼šè®°å½•ä¸€æ®µæ—‹å¾‹ -->
  <div class="modal-wrap" id="modalMelody">
    <div class="modal">
      <div class="modal-title">è®°å½•ä¸€æ®µæ—‹å¾‹</div>
      <div class="modal-desc">
        ä¸éœ€è¦ä¸“ä¸šï¼Œåªæ˜¯æŠŠä½ å“¼å‡ºæ¥çš„æ—‹å¾‹ï¼Œå…ˆè®°æˆç®€è°±æ•°å­—ï¼Œç•™ä¸€ä»½ç§å­åœ¨è¿™é‡Œã€‚
      </div>
      <div class="modal-field">
        <div class="tone-row">
          <span class="tone-label">è°ƒæ€§ï¼š</span>
          <select id="melodyKey" class="modal-select">
            <option value="C">C è°ƒ</option>
            <option value="D">D è°ƒ</option>
            <option value="E">E è°ƒ</option>
            <option value="F">F è°ƒ</option>
            <option value="G">G è°ƒ</option>
            <option value="A">A è°ƒ</option>
            <option value="B">B è°ƒ</option>
          </select>
        </div>
      </div>
      <div class="modal-field">
        <div class="modal-label">å½“å‰ç®€è°±ï¼š</div>
        <div id="melodyDisplay" class="melody-display">ï¼ˆç‚¹å‡»ä¸‹é¢çš„æ•°å­—æŒ‰é’®å¼€å§‹è®°å½•ï¼‰</div>
      </div>
      <div class="modal-field">
        <div class="modal-label">ç‚¹å‡»æ•°å­—æŒ‰é’®è®°å½•éŸ³é«˜ï¼š</div>
        <div class="melody-pad">
          <button class="btn-pad" onclick="addMelody('1')">1</button>
          <button class="btn-pad" onclick="addMelody('2')">2</button>
          <button class="btn-pad" onclick="addMelody('3')">3</button>
          <button class="btn-pad" onclick="addMelody('4')">4</button>
          <button class="btn-pad" onclick="addMelody('5')">5</button>
          <button class="btn-pad" onclick="addMelody('6')">6</button>
          <button class="btn-pad" onclick="addMelody('7')">7</button>
          <button class="btn-pad" onclick="addMelody('.')">Â·</button>
          <button class="btn-pad" onclick="melodyBackspace()">é€€æ ¼</button>
          <button class="btn-pad" onclick="melodyClear()">æ¸…ç©º</button>
        </div>
      </div>
      <div class="modal-field">
        <div class="modal-label">ç®€å•å†™ä¸€å¥å½“æ—¶çš„åœºæ™¯æˆ–å¿ƒæƒ…ï¼ˆå¯é€‰ï¼‰ï¼š</div>
        <textarea id="melodyNote" class="modal-textarea" placeholder="ä¾‹å¦‚ï¼šæ™šä¸Šåœ¨é˜³å°éšæ‰‹å“¼çš„ä¸€ä¸ªå°è°ƒå­ã€‚"></textarea>
      </div>
      <div class="modal-btn-row">
        <button class="btn-secondary" onclick="closeModal('modalMelody')">å–æ¶ˆ</button>
        <button class="btn-primary" onclick="submitMelody()">ä¿å­˜ä¸ºå¡ç‰‡</button>
      </div>
    </div>
  </div>

  <!-- è‰ºæœ¯ï¼šå°è¯´éª¨æ¶ï¼ˆä¸‰é—®ï¼‰ -->
  <div class="modal-wrap" id="modalStory">
    <div class="modal">
      <div class="modal-title">å°è¯´éª¨æ¶ Â· ä¸‰é—®</div>
      <div class="modal-desc">
        å…ˆä¸ç”¨å†™é•¿ç¯‡ï¼Œåªæ˜¯æŠŠè¿™ä¸€ç¯‡çš„å¤§è‡´éª¨æ¶æ­å‡ºæ¥ï¼Œåé¢ä½ å¯ä»¥æ…¢æ…¢å¾€é‡Œå¡«ã€‚
      </div>
      <div class="modal-field">
        <div class="modal-label">è¿™ä¸€æ¬¡æƒ³å†™çš„æ˜¯ï¼š</div>
        <input id="storyWhat" class="modal-input" placeholder="ä¸€ä¸ªäºº / ä¸€ä»¶äº‹ / ä¸€æ®µå…³ç³» / ä¸€æ¬¡æ”¹å˜â€¦" />
      </div>
      <div class="modal-field">
        <div class="modal-label">å¤§æ¦‚å‘ç”Ÿåœ¨ä»€ä¹ˆæ—¶å€™ã€ä»€ä¹ˆåœ°æ–¹ï¼Ÿ</div>
        <textarea id="storyWhenWhere" class="modal-textarea" placeholder="ä¾‹å¦‚ï¼š90 å¹´ä»£åˆï¼Œåœ¨ä¸œè¥çš„ä¸€å®¶å°é¥­é¦†é‡Œâ€¦"></textarea>
      </div>
      <div class="modal-field">
        <div class="modal-label">æˆ‘æœ€æƒ³å†™æ¸…æ¥šçš„å†²çªæˆ–å¿ƒæƒ…æ˜¯ä»€ä¹ˆï¼Ÿ</div>
        <textarea id="storyConflict" class="modal-textarea" placeholder="ä¾‹å¦‚ï¼šé‚£æ¬¡è°ˆè¯ä¹‹åï¼Œæˆ‘å¯¹è‡ªå·±æ•´ä¸ªäººç”Ÿçš„çœ‹æ³•å˜äº†ã€‚"></textarea>
      </div>
      <div class="modal-btn-row">
        <button class="btn-secondary" onclick="closeModal('modalStory')">å–æ¶ˆ</button>
        <button class="btn-primary" onclick="submitStory()">ç”Ÿæˆéª¨æ¶å¡</button>
      </div>
    </div>
  </div>

  <!-- ç…§ç‰‡å¡ -->
  <div class="modal-wrap" id="modalPhoto">
    <div class="modal">
      <div class="modal-title">æ‹ä¸€å¼  / é€‰ä¸€å¼ ç…§ç‰‡</div>
      <div class="modal-desc">
        å¯ä»¥ç”¨æ‰‹æœºç›´æ¥æ‹ç…§ï¼Œæˆ–ä»ç›¸å†Œé‡Œé€‰ä¸€å¼ ã€‚ç…§ç‰‡ä¼šå’Œä¸‹é¢è¿™æ®µæ–‡å­—ä¸€èµ·å­˜æˆä¸€å¼ â€œç…§ç‰‡å¡â€ã€‚ï¼ˆå‹æƒ…æç¤ºï¼šå›¾ç‰‡å¤ªå¤šä¼šå ç”¨è¾ƒå¤šç©ºé—´ï¼Œå»ºè®®é€‚é‡ä½¿ç”¨ï¼‰
      </div>
      <div class="modal-field">
        <div class="modal-label">é€‰æ‹©ç…§ç‰‡ï¼š</div>
        <input type="file" id="photoFile" accept="image/*" />
      </div>
      <div class="modal-field">
        <div class="modal-label">ç®€å•å†™ä¸€å¥è¯´æ˜ï¼ˆå¯é€‰ï¼‰ï¼š</div>
        <textarea id="photoNote" class="modal-textarea" placeholder="ä¾‹å¦‚ï¼šå’Œå­™å­åœ¨å°åŒºæ•£æ­¥æ—¶æ‹çš„ä¸€å¼ ç…§ç‰‡ã€‚"></textarea>
      </div>
      <div class="modal-btn-row">
        <button class="btn-secondary" onclick="closeModal('modalPhoto')">å–æ¶ˆ</button>
        <button class="btn-primary" onclick="submitPhotoCard()">ä¿å­˜ä¸ºå¡ç‰‡</button>
      </div>
    </div>
  </div>

  <!-- æ ‡ç­¾æŸ¥æ‰¾ -->
  <div class="modal-wrap" id="modalTagSearch">
    <div class="modal">
      <div class="modal-title">æŒ‰æ ‡ç­¾æ‰¾ä¸€æ‰¾</div>
      <div class="modal-desc">
        å¯ä»¥æŒ‰â€œå’Œè°æœ‰å…³â€æˆ–â€œæ˜¯å“ªä¸€ç±»äº‹â€æ¥ç­›é€‰å¡ç‰‡ã€‚é€‰ä¸­ä¸€ä¸ªæ ‡ç­¾åï¼Œåˆ—è¡¨é‡Œä¼šåªæ˜¾ç¤ºå¸¦æœ‰è¿™ä¸ªæ ‡ç­¾çš„è®°å½•ã€‚
      </div>
      <div class="modal-field">
        <div class="modal-label">å’Œè°æœ‰å…³ï¼Ÿ</div>
        <div id="searchPersonTags" class="tag-button-row"></div>
      </div>
      <div class="modal-field">
        <div class="modal-label">å¤§æ¦‚æ˜¯å“ªä¸€ç±»äº‹ï¼Ÿ</div>
        <div id="searchTopicTags" class="tag-button-row"></div>
      </div>
      <div class="modal-btn-row">
        <button class="btn-secondary" onclick="closeModal('modalTagSearch')">å…³é—­</button>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = "lt_elder_cards_v06";
    const STUDIO_CONFIG = {
      life: {
        name: "ç”Ÿæ´»å·¥ä½œå®¤",
        fullName: "ç”Ÿæ´» & å›å¿†å·¥ä½œå®¤",
        desc: "éšæ‰‹è®°ä¸€ä»¶è¿™ä¸€æ¬¡æƒ³ç•™ä½çš„å°äº‹ï¼Œä¸ç”¨å†™é•¿ç¯‡ï¼Œæ…¢æ…¢ä¹Ÿä¼šç§¯ç´¯å‡ºä¸€ä»½å¯ä»¥ç¿»çœ‹çš„ç”Ÿæ´»è®°å½•å’Œå›å¿†å½•ã€‚",
        hint: "å¯ä»¥ä»ä¸€ä»¶å°äº‹å¼€å§‹ï¼šæœ€è¿‘å‘ç”Ÿï¼Œè®©ä½ æœ‰ç‚¹åœ¨æ„çš„é‚£ä¸€æ¬¡ã€‚",
        buttons: [
          { type: "main", label: "æ–°å»ºå¡ç‰‡", handler: "openNewCard" },
          { type: "ghost", label: "éšæ‰‹è®°ä¸€å¼ å°å¡", handler: "openOnceModal" }
        ]
      },
      art: {
        name: "å¼ æ‰¬è‰ºæœ¯å·¥ä½œå®¤",
        fullName: "ä½œå“ Â· æ—‹å¾‹ Â· å°è¯´éª¨æ¶",
        desc: "å†™è¯—ã€è®°æ—‹å¾‹ã€ç•™ä½œå“è‰ç¨¿ï¼Œä¸è¦æ±‚å®Œç¾ï¼Œåªæ˜¯è®©è¿™äº›ä¸œè¥¿æœ‰ä¸€ä¸ªè¢«å®‰æ”¾çš„åœ°æ–¹ã€‚",
        hint: "å“ªæ€•åªå†™ä¸€å¥ã€è®°ä¸€å°æ®µæ—‹å¾‹ï¼Œä¹Ÿæ¯”å®Œå…¨æ²¡ç•™ä¸‹è¦å¥½å¾—å¤šã€‚",
        buttons: [
          { type: "main", label: "æ–°å»ºä½œå“å¡", handler: "openNewCard" },
          { type: "ghost", label: "è®°å½•ä¸€æ®µæ—‹å¾‹", handler: "openMelodyModal" },
          { type: "ghost", label: "å°è¯´éª¨æ¶ï¼ˆä¸‰é—®ï¼‰", handler: "openStoryModal" }
        ]
      },
      idea: {
        name: "ç†è®ºæ€æƒ³å·¥ä½œå®¤",
        fullName: "äººç”Ÿè§‚ / æ•™è‚²è§‚ / ä¿¡ä»°ä½“ä¼š",
        desc: "æŠŠå¯¹äººç”Ÿã€æ•™è‚²ã€ç¤¾å›¢æˆ–ä¿¡ä»°çš„æƒ³æ³•å†™æ¸…æ¥šï¼Œä¸æ±‚ç»Ÿä¸€æ ‡å‡†ï¼Œåªç»™è‡ªå·±ä¸€ä¸ªæ¡ç†åˆ†æ˜çš„ç‰ˆæœ¬ã€‚",
        hint: "å¯ä»¥ä»ä¸€ä¸ªå°ä¸»é¢˜å¼€å§‹ï¼šæ¯”å¦‚â€œé’±â€â€œå­©å­â€â€œå·¥ä½œâ€â€œä¿¡ä»°ä¸­çš„æŸä¸€ä¸ªé—®é¢˜â€ã€‚",
        buttons: [
          { type: "main", label: "æ–°å»ºå¡ç‰‡", handler: "openNewCard" }
        ]
      },
      tech: {
        name: "æŠ€æœ¯ & åˆ›æ„å·¥ä½œå®¤",
        fullName: "é¡¹ç›®ç»éªŒ / æŠ€æœ¯å¤‡å¿˜å½• / ç‚¹å­è‰å›¾",
        desc: "ä¸€ç”Ÿåšè¿‡çš„é¡¹ç›®ã€ç§¯ç´¯çš„æŠ€æœ¯ç»éªŒå’Œæ²¡æ¥å¾—åŠåšçš„ç‚¹å­ï¼Œå¯ä»¥æ…¢æ…¢æ‹†æˆä¸€å¼ å¼ å¡ç‰‡ï¼Œç•™ç»™åæ¥äººå‚è€ƒã€‚",
        hint: "å¯ä»¥å…ˆå†™ä¸€ä»¶ä½ æœ€æƒ³ç•™ä¸‹çš„é¡¹ç›®æˆ–ç‚¹å­ï¼Œå†æ…¢æ…¢æŠŠç»†èŠ‚è¡¥è¿›å»ã€‚",
        buttons: [
          { type: "main", label: "æ–°å»ºå¡ç‰‡", handler: "openNewCard" }
        ]
      }
    };

    const PERSON_TAGS = [
      { key: "p_self", label: "è‡ªå·±" },
      { key: "p_spouse", label: "çˆ±äºº" },
      { key: "p_children", label: "å­å¥³" },
      { key: "p_grandchildren", label: "å­™å­å­™å¥³" },
      { key: "p_parent", label: "çˆ¶æ¯é•¿è¾ˆ" },
      { key: "p_friend", label: "æœ‹å‹åŒå­¦" },
      { key: "p_colleague", label: "åŒäº‹" }
    ];

    const TOPIC_TAGS = [
      { key: "t_daily", label: "æ—¥å¸¸ç”Ÿæ´»" },
      { key: "t_work", label: "å·¥ä½œ / é¡¹ç›®" },
      { key: "t_creation", label: "ä½œå“ / åˆ›ä½œ" },
      { key: "t_belief", label: "ä¿¡ä»° / ç¤¾å›¢" },
      { key: "t_health", label: "èº«ä½“ / å¿ƒæƒ…" }
    ];

    const TAG_LABEL_MAP = {};
    PERSON_TAGS.forEach(t => TAG_LABEL_MAP[t.key] = t.label);
    TOPIC_TAGS.forEach(t => TAG_LABEL_MAP[t.key] = t.label);

    let cards = [];
    let currentStudio = "life";
    let currentView = "simple"; // simple / studio
    let editingCardId = null;
    let detailTargetId = null;
    let melodyBuffer = "";
    let photoDataUrl = null;
    let editTags = [];
    let currentTagFilter = null;

    function loadCards() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        const arr = JSON.parse(raw);
        if (!Array.isArray(arr)) return [];
        return arr.map(c => ({
          ...c,
          type: c.type || "text",
          tags: Array.isArray(c.tags) ? c.tags : []
        }));
      } catch (e) {
        return [];
      }
    }

    function saveCards() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(cards));
      } catch (e) {}
    }

    function formatTime(ts) {
      try {
        const d = new Date(ts);
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const day = String(d.getDate()).padStart(2, "0");
        const hh = String(d.getHours()).padStart(2, "0");
        const mm = String(d.getMinutes()).padStart(2, "0");
        return `${y}-${m}-${day} ${hh}:${mm}`;
      } catch (e) {
        return "";
      }
    }

    function getDefaultTagsForStudio(studio) {
      const tags = [];
      tags.push("p_self");
      if (studio === "life") tags.push("t_daily");
      if (studio === "art") tags.push("t_creation");
      if (studio === "idea") tags.push("t_belief");
      if (studio === "tech") tags.push("t_work");
      return tags;
    }

    function setCurrentStudio(studio) {
      if (!STUDIO_CONFIG[studio]) studio = "life";
      currentStudio = studio;

      const conf = STUDIO_CONFIG[studio];
      document.getElementById("studioName").textContent = conf.name;
      document.getElementById("studioFullName").textContent = conf.fullName;
      document.getElementById("studioDesc").textContent = conf.desc;
      document.getElementById("studioHint").textContent = conf.hint;

      const btnRow = document.getElementById("studioButtons");
      btnRow.innerHTML = "";
      conf.buttons.forEach(b => {
        const el = document.createElement("button");
        el.className = b.type === "main" ? "btn-main" : "btn-ghost";
        el.textContent = b.label;
        el.addEventListener("click", () => {
          if (b.handler === "openNewCard") {
            openNewCard();
          } else if (b.handler === "openOnceModal") {
            openOnceModal();
          } else if (b.handler === "openMelodyModal") {
            openMelodyModal();
          } else if (b.handler === "openStoryModal") {
            openStoryModal();
          }
        });
        btnRow.appendChild(el);
      });

      updateBottomNavActive();
      renderCardList();
    }

    function renderCardList() {
      const listEl = document.getElementById("cardList");
      listEl.innerHTML = "";
      let filtered = cards.slice();
      if (currentTagFilter) {
        filtered = filtered.filter(c => Array.isArray(c.tags) && c.tags.includes(currentTagFilter));
      } else {
        filtered = filtered.filter(c => c.studio === currentStudio);
      }
      filtered.sort((a, b) => b.createdAt - a.createdAt);

      const emptyHint = document.getElementById("emptyHint");
      if (filtered.length === 0) {
        emptyHint.style.display = "block";
        return;
      } else {
        emptyHint.style.display = "none";
      }

      filtered.forEach(card => {
        const cardEl = document.createElement("div");
        cardEl.className = "card";

        const headerLine = document.createElement("div");
        headerLine.className = "card-header-line";

        const titleEl = document.createElement("div");
        titleEl.className = "card-title";

        const iconSpan = document.createElement("span");
        iconSpan.className = "card-type-icon";
        iconSpan.textContent = card.type === "image" ? "ğŸ“·" : "ğŸ“";

        const titleTextSpan = document.createElement("span");
        titleTextSpan.textContent = card.title || "æœªå‘½åå¡ç‰‡";

        titleEl.appendChild(iconSpan);
        titleEl.appendChild(titleTextSpan);

        const metaEl = document.createElement("div");
        metaEl.className = "card-meta";
        metaEl.textContent = formatTime(card.createdAt);

        headerLine.appendChild(titleEl);
        headerLine.appendChild(metaEl);

        const contentEl = document.createElement("div");
        contentEl.className = "card-content";

        if (card.type === "image" && card.imageData) {
          const img = document.createElement("img");
          img.className = "card-image";
          img.src = card.imageData;
          img.alt = card.title || "ç…§ç‰‡å¡ç‰‡";
          contentEl.appendChild(img);

          if (card.content && card.content.trim()) {
            const p = document.createElement("div");
            p.textContent = card.content.trim();
            contentEl.appendChild(p);
          }
        } else {
          contentEl.textContent = (card.content || "").trim();
        }

        const tagsLine = document.createElement("div");
        tagsLine.className = "card-tags";
        if (Array.isArray(card.tags) && card.tags.length > 0) {
          card.tags.forEach(t => {
            const label = TAG_LABEL_MAP[t];
            if (!label) return;
            const chip = document.createElement("span");
            chip.className = "card-tag-chip";
            chip.textContent = label;
            tagsLine.appendChild(chip);
          });
        }

        const footer = document.createElement("div");
        footer.className = "card-footer";

        const btnEdit = document.createElement("button");
        btnEdit.className = "btn-small";
        btnEdit.textContent = "æ‰“å¼€ / ç¼–è¾‘";
        btnEdit.addEventListener("click", () => openEdit(card.id));
        footer.appendChild(btnEdit);

        if (card.studio === "life") {
          const btnDetail = document.createElement("button");
          btnDetail.className = "btn-small";
          btnDetail.textContent = "è¡¥ä¸€è¡¥ç»†èŠ‚";
          btnDetail.addEventListener("click", () => openDetailModal(card.id));
          footer.appendChild(btnDetail);
        }

        const btnDelete = document.createElement("button");
        btnDelete.className = "btn-small btn-small-danger";
        btnDelete.textContent = "åˆ é™¤";
        btnDelete.addEventListener("click", () => deleteCard(card.id));
        footer.appendChild(btnDelete);

        cardEl.appendChild(headerLine);
        cardEl.appendChild(contentEl);
        if (tagsLine.childNodes.length > 0) {
          cardEl.appendChild(tagsLine);
        }
        cardEl.appendChild(footer);

        listEl.appendChild(cardEl);
      });
    }

    function renderSimpleRecent() {
      const listEl = document.getElementById("simpleRecentList");
      listEl.innerHTML = "";
      if (!cards || cards.length === 0) {
        const empty = document.createElement("div");
        empty.className = "simple-recent-item";
        empty.style.cursor = "default";
        empty.textContent = "ç›®å‰è¿˜æ²¡æœ‰è®°å½•ï¼Œå¯ä»¥å…ˆè¯•ç€â€œè¯´ä¸€è¯´â€æˆ–â€œå†™ä¸€å°æ®µâ€ã€‚";
        listEl.appendChild(empty);
        return;
      }
      const sorted = cards.slice().sort((a, b) => b.createdAt - a.createdAt).slice(0, 5);
      sorted.forEach(card => {
        const row = document.createElement("div");
        row.className = "simple-recent-item";
        row.addEventListener("click", () => {
          switchView("studio");
          openEdit(card.id);
        });

        const icon = document.createElement("div");
        icon.className = "simple-recent-icon";
        icon.textContent = card.type === "image" ? "ğŸ“·" : "ğŸ“";

        const main = document.createElement("div");
        main.className = "simple-recent-main";

        const title = document.createElement("div");
        title.className = "simple-recent-title-text";
        title.textContent = card.title || "æœªå‘½åå¡ç‰‡";

        const meta = document.createElement("div");
        meta.className = "simple-recent-meta";
        meta.textContent = formatTime(card.createdAt);

        main.appendChild(title);
        main.appendChild(meta);

        row.appendChild(icon);
        row.appendChild(main);

        listEl.appendChild(row);
      });
    }

    function switchView(mode) {
      currentView = mode === "studio" ? "studio" : "simple";
      const simpleView = document.getElementById("simpleView");
      const studioView = document.getElementById("studioView");
      const tabSimple = document.getElementById("tabSimple");
      const tabStudio = document.getElementById("tabStudio");

      if (currentView === "simple") {
        simpleView.style.display = "block";
        studioView.style.display = "none";
        tabSimple.classList.add("active");
        tabStudio.classList.remove("active");
        renderSimpleRecent();
      } else {
        simpleView.style.display = "none";
        studioView.style.display = "flex";
        tabStudio.classList.add("active");
        tabSimple.classList.remove("active");
        renderCardList();
      }
    }

    function openNewCard() {
      editingCardId = null;
      editTags = getDefaultTagsForStudio(currentStudio).slice();
      document.getElementById("modalEditTitle").textContent = "æ–°å»ºå¡ç‰‡";
      document.getElementById("editTitle").value = "";
      document.getElementById("editContent").value = "";
      updateTagButtonsUI();
      openModal("modalEdit");
    }

    function openEdit(id) {
      const card = cards.find(c => c.id === id);
      if (!card) return;
      editingCardId = id;
      editTags = Array.isArray(card.tags) ? card.tags.slice() : [];
      document.getElementById("modalEditTitle").textContent = "ç¼–è¾‘å¡ç‰‡";
      document.getElementById("editTitle").value = card.title || "";
      document.getElementById("editContent").value = card.content || "";
      updateTagButtonsUI();
      openModal("modalEdit");
    }

    function saveEdit() {
      const title = document.getElementById("editTitle").value.trim();
      const content = document.getElementById("editContent").value;
      if (!content.trim()) {
        alert("è‡³å°‘å†™ä¸€ç‚¹å†…å®¹ï¼Œå†ä¿å­˜è¿™å¼ å¡ç‰‡ã€‚");
        return;
      }
      const now = Date.now();
      if (editingCardId) {
        const idx = cards.findIndex(c => c.id === editingCardId);
        if (idx >= 0) {
          cards[idx] = {
            ...cards[idx],
            type: cards[idx].type || "text",
            title,
            content,
            tags: Array.isArray(editTags) ? editTags.slice() : [],
            updatedAt: now
          };
        }
      } else {
        const id = "c_" + now + "_" + Math.random().toString(16).slice(2);
        cards.push({
          id,
          studio: currentStudio,
          type: "text",
          title,
          content,
          createdAt: now,
          updatedAt: now,
          templateType: "plain",
          tags: Array.isArray(editTags) ? editTags.slice() : getDefaultTagsForStudio(currentStudio)
        });
      }
      saveCards();
      closeModal("modalEdit");
      renderCardList();
      renderSimpleRecent();
    }

    function deleteCard(id) {
      if (!confirm("ç¡®å®šè¦åˆ é™¤è¿™å¼ å¡ç‰‡å—ï¼Ÿè¿™ä¸€æ­¥ç›®å‰ä¸èƒ½æ’¤é”€ã€‚")) return;
      cards = cards.filter(c => c.id !== id);
      saveCards();
      renderCardList();
      renderSimpleRecent();
    }

    function openModal(id) {
      const el = document.getElementById(id);
      if (el) el.classList.add("show");
    }
    function closeModal(id) {
      const el = document.getElementById(id);
      if (el) el.classList.remove("show");
      if (id === "modalDetail") {
        detailTargetId = null;
      } else if (id === "modalMelody") {
        melodyBuffer = "";
        updateMelodyDisplay();
      } else if (id === "modalPhoto") {
        photoDataUrl = null;
        const fileInput = document.getElementById("photoFile");
        if (fileInput) fileInput.value = "";
        const note = document.getElementById("photoNote");
        if (note) note.value = "";
      }
    }

    // ç®€æ˜“å…¥å£ï¼šè¯´ä¸€è¯´ / å†™ä¸€å°æ®µ / æ‹ä¸€å¼ 
    function openSimpleSay() {
      currentStudio = "life";
      editingCardId = null;
      editTags = ["p_self", "t_daily"];
      document.getElementById("modalEditTitle").textContent = "è¯´ä¸€è¯´ Â· ç”Ÿæˆæ–‡å­—å¡";
      document.getElementById("editTitle").value = "";
      const contentEl = document.getElementById("editContent");
      contentEl.value = "";
      contentEl.placeholder = "å¯ä»¥ç‚¹æ‰‹æœºé”®ç›˜ä¸Šçš„è¯­éŸ³æŒ‰é’®ï¼ˆğŸ¤ï¼‰ï¼Œå¯¹ç€æ‰‹æœºè¯´ä¸€è¯´ä»Šå¤©æƒ³è®°çš„äº‹ã€‚";
      updateTagButtonsUI();
      switchView("studio");
      openModal("modalEdit");
    }

    function openSimpleText() {
      currentStudio = "life";
      editingCardId = null;
      editTags = ["p_self", "t_daily"];
      document.getElementById("modalEditTitle").textContent = "å†™ä¸€å°æ®µ";
      document.getElementById("editTitle").value = "";
      const contentEl = document.getElementById("editContent");
      contentEl.value = "";
      contentEl.placeholder = "åªå†™å‡ è¡Œå°±å¤Ÿäº†ï¼Œä»¥åå¯ä»¥åœ¨å·¥ä½œå®¤é‡Œæ…¢æ…¢è¡¥ï¼›ä¹Ÿå¯ä»¥ç”¨è¯­éŸ³è¾“å…¥ã€‚";
      updateTagButtonsUI();
      switchView("studio");
      openModal("modalEdit");
    }

    function openPhotoModal() {
      photoDataUrl = null;
      const fileInput = document.getElementById("photoFile");
      if (fileInput) fileInput.value = "";
      const note = document.getElementById("photoNote");
      if (note) note.value = "";
      openModal("modalPhoto");
    }

    function submitPhotoCard() {
      const fileInput = document.getElementById("photoFile");
      if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
        alert("å…ˆé€‰æ‹©ä¸€å¼ ç…§ç‰‡ï¼Œå†ä¿å­˜ã€‚");
        return;
      }
      const file = fileInput.files[0];
      const reader = new FileReader();
      reader.onload = function (e) {
        photoDataUrl = e.target.result;
        const noteText = document.getElementById("photoNote").value.trim();
        const now = Date.now();
        const id = "c_" + now + "_" + Math.random().toString(16).slice(2);
        cards.push({
          id,
          studio: "life",
          type: "image",
          title: "ç…§ç‰‡è®°å½•",
          content: noteText,
          imageData: photoDataUrl,
          createdAt: now,
          updatedAt: now,
          templateType: "photo",
          tags: ["p_self", "t_daily"]
        });
        saveCards();
        closeModal("modalPhoto");
        switchView("studio");
        setCurrentStudio("life");
        renderSimpleRecent();
      };
      reader.onerror = function () {
        alert("è¯»å–ç…§ç‰‡æ—¶å‡ºäº†ä¸€ç‚¹é—®é¢˜ï¼Œå¯ä»¥å†è¯•ä¸€æ¬¡ã€‚");
      };
      reader.readAsDataURL(file);
    }

    // ç”Ÿæ´»ï¼šè¿™ä¸€æ¬¡å°å¡
    function openOnceModal() {
      document.getElementById("onceEvent").value = "";
      document.getElementById("onceDetail").value = "";
      document.getElementById("onceFuture").value = "";
      openModal("modalOnce");
    }

    function submitOnceCard() {
      const e1 = document.getElementById("onceEvent").value.trim();
      const e2 = document.getElementById("onceDetail").value.trim();
      const e3 = document.getElementById("onceFuture").value.trim();
      if (!e1 && !e2 && !e3) {
        alert("è‡³å°‘å†™ä¸€ç‚¹å†…å®¹ï¼Œå†ç”Ÿæˆè¿™å¼ å°å¡ã€‚");
        return;
      }
      const now = Date.now();
      let content = "ã€è¿™ä¸€æ¬¡ã€‘\n";
      if (e1) content += "Â· æˆ‘æƒ³è®°ä½çš„ä¸€ä»¶å°äº‹ï¼š\n" + e1 + "\n\n";
      if (e2) content += "Â· è®©æˆ‘åœ¨æ„çš„ä¸€ä¸ªç»†èŠ‚ï¼š\n" + e2 + "\n\n";
      if (e3) content += "Â· ä»¥åå†çœ‹åˆ°æ—¶ï¼Œå¸Œæœ›è‡ªå·±èƒ½æƒ³èµ·ï¼š\n" + e3 + "\n";
      const title = "è¿™ä¸€æ¬¡å°å¡";
      const id = "c_" + now + "_" + Math.random().toString(16).slice(2);
      cards.push({
        id,
        studio: "life",
        type: "text",
        title,
        content,
        createdAt: now,
        updatedAt: now,
        templateType: "once_note",
        tags: ["p_self", "t_daily"]
      });
      saveCards();
      closeModal("modalOnce");
      setCurrentStudio("life");
      renderSimpleRecent();
    }

    // ç”Ÿæ´»ï¼šè¡¥ä¸€è¡¥ç»†èŠ‚
    function openDetailModal(cardId) {
      detailTargetId = cardId;
      document.getElementById("detailWhen").value = "";
      document.getElementById("detailWhere").value = "";
      document.getElementById("detailEvent").value = "";
      openModal("modalDetail");
    }

    function submitDetail() {
      if (!detailTargetId) {
        closeModal("modalDetail");
        return;
      }
      const w = document.getElementById("detailWhen").value.trim();
      const where = document.getElementById("detailWhere").value.trim();
      const ev = document.getElementById("detailEvent").value.trim();
      if (!w && !where && !ev) {
        alert("å¯ä»¥åªå†™ä¸€ä¸¤é¡¹ï¼Œä½†ä¸èƒ½å…¨éƒ¨ç©ºç€ã€‚");
        return;
      }
      const idx = cards.findIndex(c => c.id === detailTargetId);
      if (idx < 0) {
        closeModal("modalDetail");
        return;
      }
      let extra = "\n\nã€è¡¥å……ç»†èŠ‚ã€‘\n";
      if (w) extra += "Â· å¤§æ¦‚çš„é˜¶æ®µï¼š\n" + w + "\n\n";
      if (where) extra += "Â· æ‰€åœ¨çš„åœ°æ–¹ / ç¯å¢ƒï¼š\n" + where + "\n\n";
      if (ev) extra += "Â· ä¸€ä»¶æœ€å…¸å‹çš„å°äº‹ï¼š\n" + ev + "\n";
      cards[idx] = {
        ...cards[idx],
        content: (cards[idx].content || "") + extra,
        updatedAt: Date.now()
      };
      saveCards();
      closeModal("modalDetail");
      renderCardList();
      renderSimpleRecent();
    }

    // è‰ºæœ¯ï¼šè®°å½•æ—‹å¾‹
    function openMelodyModal() {
      melodyBuffer = "";
      updateMelodyDisplay();
      document.getElementById("melodyKey").value = "C";
      document.getElementById("melodyNote").value = "";
      openModal("modalMelody");
    }

    function updateMelodyDisplay() {
      const el = document.getElementById("melodyDisplay");
      if (!el) return;
      const trimmed = melodyBuffer.trim();
      el.textContent = trimmed || "ï¼ˆç‚¹å‡»ä¸‹é¢çš„æ•°å­—æŒ‰é’®å¼€å§‹è®°å½•ï¼‰";
    }

    function addMelody(sym) {
      melodyBuffer = (melodyBuffer + " " + sym).trim();
      updateMelodyDisplay();
    }

    function melodyBackspace() {
      if (!melodyBuffer) return;
      const parts = melodyBuffer.trim().split(/\s+/);
      parts.pop();
      melodyBuffer = parts.join(" ");
      updateMelodyDisplay();
    }

    function melodyClear() {
      melodyBuffer = "";
      updateMelodyDisplay();
    }

    function submitMelody() {
      const seq = melodyBuffer.trim();
      if (!seq) {
        alert("å…ˆç”¨æ•°å­—æŒ‰é’®è®°ä¸€ç‚¹æ—‹å¾‹ï¼Œå†ä¿å­˜ã€‚");
        return;
      }
      const key = document.getElementById("melodyKey").value || "C";
      const note = document.getElementById("melodyNote").value.trim();
      const now = Date.now();
      let content = `ã€æ—‹å¾‹è‰ç¨¿ã€‘\nÂ· è°ƒæ€§ï¼š${key} è°ƒ\nÂ· ç®€è°±ï¼š\n${seq}\n`;
      if (note) {
        content += "\nÂ· åœºæ™¯ / å¿ƒæƒ…å¤‡æ³¨ï¼š\n" + note + "\n";
      }
      const title = "æ—‹å¾‹è‰ç¨¿";
      const id = "c_" + now + "_" + Math.random().toString(16).slice(2);
      cards.push({
        id,
        studio: "art",
        type: "text",
        title,
        content,
        createdAt: now,
        updatedAt: now,
        templateType: "melody_seed",
        tags: ["p_self", "t_creation"]
      });
      saveCards();
      closeModal("modalMelody");
      setCurrentStudio("art");
      renderSimpleRecent();
    }

    // è‰ºæœ¯ï¼šå°è¯´éª¨æ¶
    function openStoryModal() {
      document.getElementById("storyWhat").value = "";
      document.getElementById("storyWhenWhere").value = "";
      document.getElementById("storyConflict").value = "";
      openModal("modalStory");
    }

    function submitStory() {
      const w = document.getElementById("storyWhat").value.trim();
      const ww = document.getElementById("storyWhenWhere").value.trim();
      const cf = document.getElementById("storyConflict").value.trim();
      if (!w && !ww && !cf) {
        alert("è‡³å°‘å†™ä¸€ç‚¹ï¼Œå†ç”Ÿæˆéª¨æ¶å¡ã€‚");
        return;
      }
      const now = Date.now();
      let content = "ã€å°è¯´éª¨æ¶ã€‘\n";
      if (w) content += "Â· æƒ³å†™çš„æ˜¯ï¼š\n" + w + "\n\n";
      if (ww) content += "Â· å‘ç”Ÿçš„æ—¶é—´ / åœ°æ–¹ï¼š\n" + ww + "\n\n";
      if (cf) content += "Â· æœ€æƒ³å†™æ¸…æ¥šçš„å†²çª / å¿ƒæƒ…ï¼š\n" + cf + "\n";
      const title = "å°è¯´éª¨æ¶";
      const id = "c_" + now + "_" + Math.random().toString(16).slice(2);
      cards.push({
        id,
        studio: "art",
        type: "text",
        title,
        content,
        createdAt: now,
        updatedAt: now,
        templateType: "story_skeleton",
        tags: ["p_self", "t_creation"]
      });
      saveCards();
      closeModal("modalStory");
      setCurrentStudio("art");
      renderSimpleRecent();
    }

    // åº•éƒ¨å¯¼èˆªç›¸å…³
    function updateBottomNavActive() {
      const buttons = document.querySelectorAll(".bottom-nav-btn[data-studio]");
      buttons.forEach(btn => {
        const s = btn.getAttribute("data-studio");
        btn.classList.toggle("active", s === currentStudio && !currentTagFilter);
      });
    }

    function switchStudio(studio) {
      if (currentView !== "studio") {
        switchView("studio");
      }
      clearTagFilter(false);
      setCurrentStudio(studio);
    }

    function goHome() {
      window.location.href = "index.html?home=1";
    }

    // æ ‡ç­¾æŒ‰é’® UI
    function initTagButtons() {
      const editPerson = document.getElementById("editPersonTags");
      const editTopic = document.getElementById("editTopicTags");
      const searchPerson = document.getElementById("searchPersonTags");
      const searchTopic = document.getElementById("searchTopicTags");

      PERSON_TAGS.forEach(t => {
        const btn1 = document.createElement("button");
        btn1.className = "tag-btn";
        btn1.textContent = t.label;
        btn1.dataset.tagKey = t.key;
        editPerson.appendChild(btn1);

        const btn2 = document.createElement("button");
        btn2.className = "tag-btn";
        btn2.textContent = t.label;
        btn2.dataset.tagKey = t.key;
        searchPerson.appendChild(btn2);
      });

      TOPIC_TAGS.forEach(t => {
        const btn1 = document.createElement("button");
        btn1.className = "tag-btn";
        btn1.textContent = t.label;
        btn1.dataset.tagKey = t.key;
        editTopic.appendChild(btn1);

        const btn2 = document.createElement("button");
        btn2.className = "tag-btn";
        btn2.textContent = t.label;
        btn2.dataset.tagKey = t.key;
        searchTopic.appendChild(btn2);
      });

      editPerson.addEventListener("click", e => {
        const key = e.target && e.target.dataset && e.target.dataset.tagKey;
        if (!key) return;
        toggleEditTag(key);
      });
      editTopic.addEventListener("click", e => {
        const key = e.target && e.target.dataset && e.target.dataset.tagKey;
        if (!key) return;
        toggleEditTag(key);
      });

      searchPerson.addEventListener("click", e => {
        const key = e.target && e.target.dataset && e.target.dataset.tagKey;
        if (!key) return;
        selectTagFilter(key);
      });
      searchTopic.addEventListener("click", e => {
        const key = e.target && e.target.dataset && e.target.dataset.tagKey;
        if (!key) return;
        selectTagFilter(key);
      });
    }

    function toggleEditTag(key) {
      if (!Array.isArray(editTags)) editTags = [];
      const idx = editTags.indexOf(key);
      if (idx >= 0) {
        editTags.splice(idx, 1);
      } else {
        editTags.push(key);
      }
      updateTagButtonsUI();
    }

    function updateTagButtonsUI() {
      const editPerson = document.getElementById("editPersonTags");
      const editTopic = document.getElementById("editTopicTags");
      if (!editPerson || !editTopic) return;
      const all = [...editPerson.querySelectorAll(".tag-btn"), ...editTopic.querySelectorAll(".tag-btn")];
      all.forEach(btn => {
        const key = btn.dataset.tagKey;
        if (!key) return;
        const active = Array.isArray(editTags) && editTags.includes(key);
        btn.classList.toggle("tag-active", active);
      });
    }

    function openTagSearchModal() {
      openModal("modalTagSearch");
    }

    function selectTagFilter(key) {
      currentTagFilter = key;
      const info = document.getElementById("tagFilterInfo");
      const labelEl = document.getElementById("tagFilterLabel");
      const label = TAG_LABEL_MAP[key] || "";
      if (info && labelEl) {
        labelEl.textContent = label;
        info.style.display = "block";
      }
      renderCardList();
      closeModal("modalTagSearch");
    }

    function clearTagFilter(reRender = true) {
      currentTagFilter = null;
      const info = document.getElementById("tagFilterInfo");
      const labelEl = document.getElementById("tagFilterLabel");
      if (info && labelEl) {
        labelEl.textContent = "";
        info.style.display = "none";
      }
      if (reRender) {
        renderCardList();
      }
      updateBottomNavActive();
    }

    // å¤‡ä»½å¯¼å‡º/å¯¼å…¥
    function exportBackup() {
      if (!cards || cards.length === 0) {
        alert("å½“å‰è¿˜æ²¡æœ‰ä»»ä½•å¡ç‰‡å¯ä¾›å¤‡ä»½ã€‚");
        return;
      }
      const payload = {
        version: "0.7-local",
        exportedAt: new Date().toISOString(),
        cards
      };
      const json = JSON.stringify(payload, null, 2);
      const blob = new Blob([json], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const time = formatTime(Date.now()).replace(/[: ]/g, "_");
      a.href = url;
      a.download = "elder_studio_backup_" + time + ".json";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function triggerImport() {
      const input = document.getElementById("importFile");
      if (!input) return;
      input.value = "";
      input.click();
    }

    function handleImportFile(event) {
      const file = event.target.files && event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          const txt = e.target.result;
          const obj = JSON.parse(txt);
          const newCards = Array.isArray(obj) ? obj : obj.cards;
          if (!Array.isArray(newCards)) {
            alert("è¿™ä¸ªå¤‡ä»½æ–‡ä»¶æ ¼å¼ä¸å¯¹ï¼Œæ— æ³•å¯¼å…¥ã€‚");
            return;
          }
          if (!confirm("å¯¼å…¥å¤‡ä»½ä¼šç”¨å¤‡ä»½å†…å®¹æ›¿æ¢å½“å‰çš„å¡ç‰‡åˆ—è¡¨ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ")) {
            return;
          }
          cards = newCards.map(c => ({
            ...c,
            type: c.type || "text",
            tags: Array.isArray(c.tags) ? c.tags : []
          }));
          saveCards();
          renderCardList();
          renderSimpleRecent();
          alert("å¤‡ä»½å¯¼å…¥å®Œæˆã€‚");
        } catch (err) {
          alert("è§£æå¤‡ä»½æ–‡ä»¶æ—¶å‡ºé”™ï¼Œæ— æ³•å¯¼å…¥ã€‚");
        }
      };
      reader.onerror = function () {
        alert("è¯»å–å¤‡ä»½æ–‡ä»¶æ—¶å‡ºé”™ã€‚");
      };
      reader.readAsText(file, "utf-8");
    }

    document.addEventListener("DOMContentLoaded", () => {
      initTagButtons();
      cards = loadCards();
      switchView("simple");
      setCurrentStudio(currentStudio);
      renderSimpleRecent();
    });
  </script>
</body>
</html>
